<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Debug</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    .log { background: #252526; padding: 10px; margin: 5px 0; border-left: 3px solid #007acc; }
    .error { border-left-color: #f48771; }
    .success { border-left-color: #89d185; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>WebSocket Connection Debug</h2>
  <div id="status">Initializing...</div>
  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button>
  <button onclick="clearLogs()">Clear</button>
  <div id="logs"></div>

  <script>
    let ws = null;
    const host = window.location.hostname;
    const port = window.location.port || '3000';
    const wsUrl = `ws://${host}:${port}/ws/video`;

    function log(msg, type = 'log') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('logs').prepend(div);
    }

    function updateStatus(msg, color = '#007acc') {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.style.color = color;
    }

    function connect() {
      if (ws && ws.readyState !== WebSocket.CLOSED) {
        log('Already connected or connecting', 'error');
        return;
      }

      log(`Connecting to: ${wsUrl}`);
      updateStatus('Connecting...', '#ffa500');

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log('âœ… WebSocket CONNECTED', 'success');
        updateStatus('Connected', '#89d185');
      };

      ws.onmessage = (event) => {
        log(`ðŸ“¨ Message: ${event.data}`, 'success');
      };

      ws.onerror = (error) => {
        log(`âŒ Error: ${error}`, 'error');
        updateStatus('Error', '#f48771');
      };

      ws.onclose = (event) => {
        log(`ðŸ”Œ Closed: code=${event.code}, reason=${event.reason}`, 'error');
        updateStatus('Disconnected', '#f48771');
      };

      // Timeout check
      setTimeout(() => {
        if (ws.readyState === WebSocket.CONNECTING) {
          log('â±ï¸ Connection timeout - still in CONNECTING state', 'error');
          ws.close();
        }
      }, 5000);
    }

    function disconnect() {
      if (ws) {
        ws.close();
        log('Disconnecting...');
      }
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    // Auto-connect on load
    window.onload = () => {
      log('Page loaded');
      log(`Target: ${wsUrl}`);
      setTimeout(connect, 500);
    };
  </script>
</body>
</html>
