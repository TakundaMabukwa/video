<!DOCTYPE html>
<html>
<head>
  <title>Live Video Player</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1e1e1e; color: #fff; margin: 0; }
    .container { max-width: 1400px; margin: 0 auto; }
    h2 { margin: 0 0 20px 0; }
    .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(640px, 1fr)); gap: 20px; margin-top: 20px; }
    .video-container { background: #252526; border-radius: 8px; padding: 15px; }
    .video-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .video-title { font-size: 16px; font-weight: bold; color: #4ec9b0; }
    .video-status { font-size: 12px; color: #888; }
    canvas { width: 100%; height: auto; background: #000; border-radius: 4px; }
    .stats { font-size: 11px; color: #888; margin-top: 8px; font-family: monospace; }
    .controls { margin-top: 10px; }
    button { background: #0e639c; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px; }
    button:hover { background: #1177bb; }
    button:disabled { background: #555; cursor: not-allowed; }
    .error { color: #f48771; }
    .success { color: #4ec9b0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸŽ¥ Live Video Player - H.264 Decoder</h2>
    
    <div id="vehicles-list"></div>
    
    <div class="video-grid" id="video-grid"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/broadway-player@1.0.5/Player/Decoder.js"></script>
  <script>
    const players = new Map();
    let eventSource = null;

    class VideoPlayer {
      constructor(vehicleId, channel) {
        this.vehicleId = vehicleId;
        this.channel = channel;
        this.frameCount = 0;
        this.iframeCount = 0;
        this.lastFrameTime = Date.now();
        this.fps = 0;
        
        this.container = this.createContainer();
        this.canvas = this.container.querySelector('canvas');
        this.statsEl = this.container.querySelector('.stats');
        
        // Initialize Broadway H.264 decoder
        this.decoder = new Decoder({
          rgb: true,
          size: { width: 1920, height: 1080 }
        });
        
        this.decoder.onPictureDecoded = (buffer, width, height) => {
          this.renderFrame(buffer, width, height);
        };
      }

      createContainer() {
        const container = document.createElement('div');
        container.className = 'video-container';
        container.innerHTML = `
          <div class="video-header">
            <div class="video-title">ðŸ“¹ ${this.vehicleId} - Channel ${this.channel}</div>
            <div class="video-status">Waiting for I-frame...</div>
          </div>
          <canvas width="1920" height="1080"></canvas>
          <div class="stats">Frames: 0 | I-Frames: 0 | FPS: 0</div>
        `;
        document.getElementById('video-grid').appendChild(container);
        return container;
      }

      processFrame(frameData, isIFrame) {
        try {
          // Decode base64 to Uint8Array
          const binary = atob(frameData);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          
          // Feed to decoder
          this.decoder.decode(bytes);
          
          this.frameCount++;
          if (isIFrame) this.iframeCount++;
          
          // Calculate FPS
          const now = Date.now();
          const elapsed = (now - this.lastFrameTime) / 1000;
          if (elapsed > 0) {
            this.fps = Math.round(1 / elapsed);
          }
          this.lastFrameTime = now;
          
          this.updateStats();
        } catch (error) {
          console.error('Decode error:', error);
        }
      }

      renderFrame(buffer, width, height) {
        const ctx = this.canvas.getContext('2d');
        
        // Update canvas size if needed
        if (this.canvas.width !== width || this.canvas.height !== height) {
          this.canvas.width = width;
          this.canvas.height = height;
        }
        
        // Convert YUV to RGB and draw
        const imageData = ctx.createImageData(width, height);
        imageData.data.set(buffer);
        ctx.putImageData(imageData, 0, 0);
        
        this.container.querySelector('.video-status').textContent = 'Streaming';
        this.container.querySelector('.video-status').className = 'video-status success';
      }

      updateStats() {
        this.statsEl.textContent = `Frames: ${this.frameCount} | I-Frames: ${this.iframeCount} | FPS: ${this.fps}`;
      }
    }

    function startStream() {
      const url = `/api/stream/sse`;
      console.log('Connecting to SSE...');

      eventSource = new EventSource(url);

      eventSource.onopen = () => {
        console.log('âœ… SSE Connected');
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'frame') {
            const key = `${data.vehicleId}_${data.channel}`;
            
            // Create player if doesn't exist
            if (!players.has(key)) {
              players.set(key, new VideoPlayer(data.vehicleId, data.channel));
            }
            
            // Process frame
            const player = players.get(key);
            player.processFrame(data.data, data.isIFrame);
          }
        } catch (error) {
          console.error('Parse error:', error);
        }
      };

      eventSource.onerror = (error) => {
        console.error('SSE Error:', error);
        setTimeout(startStream, 3000);
      };
    }

    window.onload = () => {
      startStream();
    };

    window.onbeforeunload = () => {
      if (eventSource) eventSource.close();
    };
  </script>
</body>
</html>
