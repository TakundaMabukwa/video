<!DOCTYPE html>
<html>
<head>
  <title>Live Video - Motion JPEG</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1e1e1e; color: #fff; margin: 0; }
    .container { max-width: 1600px; margin: 0 auto; }
    h2 { margin: 0 0 20px 0; }
    .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(640px, 1fr)); gap: 20px; }
    .video-container { background: #252526; border-radius: 8px; padding: 15px; }
    .video-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .video-title { font-size: 16px; font-weight: bold; color: #4ec9b0; }
    .video-status { font-size: 12px; }
    .streaming { color: #4ec9b0; }
    .waiting { color: #ffa500; }
    img { width: 100%; height: auto; background: #000; border-radius: 4px; display: block; min-height: 360px; }
    .stats { font-size: 11px; color: #888; margin-top: 8px; font-family: monospace; }
    .iframe-indicator { color: #ce9178; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸŽ¥ Live Video - Motion JPEG Stream</h2>
    <div class="video-grid" id="video-grid"></div>
  </div>

  <script>
    const players = new Map();
    let eventSource = null;

    class MotionJPEGPlayer {
      constructor(vehicleId, channel) {
        this.vehicleId = vehicleId;
        this.channel = channel;
        this.frameCount = 0;
        this.iframeCount = 0;
        this.lastFrameTime = Date.now();
        this.fps = 0;
        
        this.container = this.createContainer();
        this.img = this.container.querySelector('img');
        this.statusEl = this.container.querySelector('.video-status');
        this.statsEl = this.container.querySelector('.stats');
      }

      createContainer() {
        const container = document.createElement('div');
        container.className = 'video-container';
        container.innerHTML = `
          <div class="video-header">
            <div class="video-title">ðŸ“¹ ${this.vehicleId} - Channel ${this.channel}</div>
            <div class="video-status waiting">Waiting for frames...</div>
          </div>
          <img alt="Video stream">
          <div class="stats">Frames: 0 | I-Frames: 0 | FPS: 0</div>
        `;
        document.getElementById('video-grid').appendChild(container);
        return container;
      }

      processFrame(frameData, isIFrame) {
        // Display frame as image (base64 data URL)
        // Note: H.264 frames won't display directly, but this shows the concept
        // For actual video, you'd need to decode H.264 or use HLS
        
        this.frameCount++;
        if (isIFrame) this.iframeCount++;
        
        // Calculate FPS
        const now = Date.now();
        const elapsed = (now - this.lastFrameTime) / 1000;
        if (elapsed > 0) {
          this.fps = Math.round(1 / elapsed);
        }
        this.lastFrameTime = now;
        
        // Try to display (won't work for H.264, but shows activity)
        // this.img.src = 'data:image/jpeg;base64,' + frameData;
        
        // Instead, show frame indicator
        this.showFrameIndicator(isIFrame);
        
        this.updateStats();
        this.statusEl.textContent = 'Streaming';
        this.statusEl.className = 'video-status streaming';
      }

      showFrameIndicator(isIFrame) {
        // Create a canvas to show frame activity
        if (!this.canvas) {
          this.canvas = document.createElement('canvas');
          this.canvas.width = 1280;
          this.canvas.height = 720;
          this.img.replaceWith(this.canvas);
          this.ctx = this.canvas.getContext('2d');
        }
        
        // Draw frame indicator
        this.ctx.fillStyle = '#000';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.ctx.fillStyle = isIFrame ? '#4ec9b0' : '#888';
        this.ctx.font = 'bold 64px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(
          isIFrame ? 'ðŸŽ¬ I-FRAME' : 'ðŸ“¹ P-FRAME',
          this.canvas.width / 2,
          this.canvas.height / 2 - 60
        );
        
        this.ctx.font = '32px Arial';
        this.ctx.fillStyle = '#fff';
        this.ctx.fillText(
          `Frame #${this.frameCount}`,
          this.canvas.width / 2,
          this.canvas.height / 2 + 20
        );
        
        this.ctx.font = '24px Arial';
        this.ctx.fillStyle = '#888';
        this.ctx.fillText(
          `${this.vehicleId} - Channel ${this.channel}`,
          this.canvas.width / 2,
          this.canvas.height / 2 + 70
        );
        
        this.ctx.fillText(
          `${this.fps} FPS`,
          this.canvas.width / 2,
          this.canvas.height / 2 + 110
        );
      }

      updateStats() {
        this.statsEl.innerHTML = `Frames: ${this.frameCount} | <span class="iframe-indicator">I-Frames: ${this.iframeCount}</span> | FPS: ${this.fps}`;
      }
    }

    function startStream() {
      const url = `/api/stream/sse`;
      console.log('Connecting to SSE...');

      eventSource = new EventSource(url);

      eventSource.onopen = () => {
        console.log('âœ… SSE Connected');
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'frame') {
            const key = `${data.vehicleId}_${data.channel}`;
            
            if (!players.has(key)) {
              console.log(`ðŸ“¹ New stream: ${data.vehicleId} Ch${data.channel}`);
              players.set(key, new MotionJPEGPlayer(data.vehicleId, data.channel));
            }
            
            const player = players.get(key);
            player.processFrame(data.data, data.isIFrame);
          }
        } catch (error) {
          console.error('Parse error:', error);
        }
      };

      eventSource.onerror = (error) => {
        console.error('SSE Error:', error);
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }
        setTimeout(startStream, 3000);
      };
    }

    window.onload = () => {
      console.log('Page loaded - connecting...');
      startStream();
    };

    window.onbeforeunload = () => {
      if (eventSource) eventSource.close();
    };
  </script>
</body>
</html>
