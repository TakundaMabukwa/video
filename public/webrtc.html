<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Video Stream</title>
</head>
<body>
  <h1>WebRTC Video Stream</h1>
  <video id="video" autoplay playsinline controls style="width:100%;max-width:800px;"></video>
  <div id="status">Connecting...</div>
  
  <script>
    const ws = new WebSocket('ws://164.90.182.2:3000/webrtc');
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    
    let peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    
    ws.onopen = () => {
      status.textContent = 'Connected - Waiting for video...';
      initPeerConnection();
    };
    
    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      
      if (msg.type === 'video-data') {
        console.log('Received video data:', msg.vehicleId, msg.data.length);
      } else if (msg.type === 'offer') {
        handleOffer(msg);
      } else if (msg.type === 'answer') {
        handleAnswer(msg);
      } else if (msg.type === 'ice-candidate') {
        handleIceCandidate(msg);
      }
    };
    
    async function handleOffer(msg) {
      await peerConnection.setRemoteDescription(msg.offer);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      ws.send(JSON.stringify({ type: 'answer', answer }));
    }
    
    async function handleAnswer(msg) {
      await peerConnection.setRemoteDescription(msg.answer);
    }
    
    function handleIceCandidate(msg) {
      peerConnection.addIceCandidate(msg.candidate);
    }
    
    function initPeerConnection() {
      peerConnection = new RTCPeerConnection(config);
      
      peerConnection.ontrack = (event) => {
        video.srcObject = event.streams[0];
        status.textContent = 'Streaming âœ…';
      };
      
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate }));
        }
      };
    }
  </script>
</body>
</html>
