<!DOCTYPE html>
<html>
<head>
  <title>Live Video - WebSocket</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1e1e1e; color: #fff; margin: 0; }
    .container { max-width: 1400px; margin: 0 auto; }
    h2 { margin: 0 0 20px 0; }
    .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(640px, 1fr)); gap: 20px; margin-top: 20px; }
    .video-container { background: #252526; border-radius: 8px; padding: 15px; }
    .video-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .video-title { font-size: 16px; font-weight: bold; color: #4ec9b0; }
    .video-status { font-size: 12px; }
    .streaming { color: #4ec9b0; }
    .waiting { color: #ffa500; }
    canvas { width: 100%; height: auto; background: #000; border-radius: 4px; display: block; }
    .stats { font-size: 11px; color: #888; margin-top: 8px; font-family: monospace; }
    #log { height: 200px; overflow-y: auto; background: #252526; padding: 10px; font-family: monospace; font-size: 11px; margin-top: 20px; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸŽ¥ Live Video Player - WebSocket Stream</h2>
    
    <div class="video-grid" id="video-grid"></div>
    
    <div id="log"></div>
  </div>

  <script>
    const players = new Map();
    let ws = null;

    function log(msg) {
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('log').prepend(div);
    }

    class VideoPlayer {
      constructor(vehicleId, channel) {
        this.vehicleId = vehicleId;
        this.channel = channel;
        this.frameCount = 0;
        this.iframeCount = 0;
        this.lastFrameTime = Date.now();
        this.fps = 0;
        this.frameBuffer = [];
        
        this.container = this.createContainer();
        this.canvas = this.container.querySelector('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.statsEl = this.container.querySelector('.stats');
        this.statusEl = this.container.querySelector('.video-status');
      }

      createContainer() {
        const container = document.createElement('div');
        container.className = 'video-container';
        container.innerHTML = `
          <div class="video-header">
            <div class="video-title">ðŸ“¹ ${this.vehicleId} - Channel ${this.channel}</div>
            <div class="video-status waiting">Waiting for video...</div>
          </div>
          <canvas width="1280" height="720"></canvas>
          <div class="stats">Frames: 0 | I-Frames: 0 | FPS: 0 | Buffer: 0</div>
        `;
        document.getElementById('video-grid').appendChild(container);
        return container;
      }

      processFrame(frameData, isIFrame) {
        this.frameCount++;
        if (isIFrame) this.iframeCount++;
        
        // Calculate FPS
        const now = Date.now();
        const elapsed = (now - this.lastFrameTime) / 1000;
        if (elapsed > 0) {
          this.fps = Math.round(1 / elapsed);
        }
        this.lastFrameTime = now;
        
        // Add to buffer
        this.frameBuffer.push({ data: frameData, isIFrame });
        if (this.frameBuffer.length > 30) {
          this.frameBuffer.shift();
        }
        
        // Try to render (placeholder - shows frame info)
        this.renderPlaceholder(isIFrame);
        
        this.updateStats();
        this.statusEl.textContent = 'Streaming';
        this.statusEl.className = 'video-status streaming';
      }

      renderPlaceholder(isIFrame) {
        // Draw placeholder with frame info
        this.ctx.fillStyle = '#000';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.ctx.fillStyle = isIFrame ? '#4ec9b0' : '#888';
        this.ctx.font = '48px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(
          isIFrame ? 'ðŸŽ¬ I-FRAME' : 'ðŸ“¹ P-FRAME',
          this.canvas.width / 2,
          this.canvas.height / 2 - 40
        );
        
        this.ctx.font = '24px Arial';
        this.ctx.fillStyle = '#fff';
        this.ctx.fillText(
          `Frame #${this.frameCount}`,
          this.canvas.width / 2,
          this.canvas.height / 2 + 20
        );
        
        this.ctx.fillText(
          `${this.vehicleId} - Ch${this.channel}`,
          this.canvas.width / 2,
          this.canvas.height / 2 + 60
        );
      }

      updateStats() {
        this.statsEl.textContent = `Frames: ${this.frameCount} | I-Frames: ${this.iframeCount} | FPS: ${this.fps} | Buffer: ${this.frameBuffer.length}`;
      }
    }

    function connectWebSocket() {
      const wsUrl = `ws://${window.location.host}/ws/video`;
      log(`Connecting to ${wsUrl}...`);
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log('âœ… WebSocket Connected');
        // Subscribe to all streams (server will auto-start)
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'frame') {
            const key = `${data.vehicleId}_${data.channel}`;
            
            if (!players.has(key)) {
              log(`ðŸ“¹ New stream: ${data.vehicleId} Ch${data.channel}`);
              players.set(key, new VideoPlayer(data.vehicleId, data.channel));
            }
            
            const player = players.get(key);
            player.processFrame(data.data, data.isIFrame);
          }
        } catch (error) {
          console.error('Parse error:', error);
        }
      };

      ws.onerror = (error) => {
        log('âŒ WebSocket Error');
        console.error(error);
      };

      ws.onclose = () => {
        log('WebSocket closed - reconnecting in 3s...');
        setTimeout(connectWebSocket, 3000);
      };
    }

    window.onload = () => {
      log('Page loaded - connecting...');
      connectWebSocket();
    };

    window.onbeforeunload = () => {
      if (ws) ws.close();
    };
  </script>
</body>
</html>
